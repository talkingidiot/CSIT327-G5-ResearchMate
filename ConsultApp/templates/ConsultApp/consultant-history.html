{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consultant â€” History</title>
  <link rel="stylesheet" href="{% static 'ConsultApp/student.css'%}">
  <link rel="stylesheet" href="{% static 'ConsultApp/consultant.css'%}">
  <link rel="stylesheet" href="{% static 'ConsultApp/consultant-dashboard.css'%}">
</head>
<body>
  <nav class="top-nav">
    <div class="logo">ResearchMate</div>
    
    <div class="nav-links">
      <a href="{% url 'consultant_dashboard' %}">ğŸ  Dashboard</a>
      <a href="{% url 'consultant_profile' %}">ğŸ‘¤ My Profile</a>
      <a href="{% url 'consultant_students' %}">ğŸ§‘â€ğŸ“ Students</a>
      <a href="{% url 'consultant_appointments' %}">ğŸ“… Appointments</a>
      <a href="{% url 'consultant_history' %}" class="active">ğŸ“œ History</a>
    </div>

    <div class="user-section">
      <span class="consultant-label">Consultant</span>
      <form method="POST" action="{% url 'logout' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="logout-btn">ğŸšª Logout</button>
      </form>
    </div>
  </nav>

  <div id="detailsModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <h2>Session Details</h2>
      <div id="detailsContent"></div>
      <div class="modal-actions">
        <button class="btn-close" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <main class="main-content">
    
    <div class="page-header">
      <h1>Consultation History</h1>
      <p>View your completed and cancelled sessions</p>
    </div>

    <div class="filter-section">
      <div class="filter-controls">
        <select id="timeFilter">
          <option value="all">All Time</option>
          <option value="30">Last 30 days</option>
          <option value="90">Last 3 months</option>
          <option value="365">Last year</option>
        </select>

        <select id="statusFilter">
          <option value="all">All Statuses</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div class="results-count">
        Showing <span id="visibleCount">{{ appointments|length }}</span> past record(s)
      </div>
    </div>

    <div class="history-grid">
      {% if appointments %}
        {% for appointment in appointments %}
          <div class="booking-card" 
               data-status="{{ appointment.status }}" 
               data-date="{{ appointment.date|date:'Y-m-d' }}">
            
            <div class="booking-header">
              <div class="consultant-info">
                <h3>{{ appointment.student.user.get_full_name }}</h3>
                <p class="specialty">{{ appointment.student.student_program|default:"Student" }}</p>
              </div>
              
              {% if appointment.status == 'completed' %}
                <span class="status-badge completed">ğŸ Completed</span>
              {% elif appointment.status == 'cancelled' %}
                <span class="status-badge cancelled">âŒ Cancelled</span>
              {% endif %}
            </div>

            <div class="booking-details">
              <div class="detail-row">
                <span class="label">Purpose:</span>
                <span class="value">{{ appointment.topic }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Date:</span>
                <span class="value">{{ appointment.date|date:"M d, Y" }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Time:</span>
                <span class="value">{{ appointment.time|time:"g:i A" }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Duration:</span>
                <span class="value">{{ appointment.duration_minutes }} minutes</span>
              </div>
            </div>

            <div class="booking-actions">
              <button class="btn-details"
                onclick="openDetails(
                    '{{ appointment.id }}',
                    '{{ appointment.topic }}',
                    '{{ appointment.date|date:"M d, Y" }}',
                    '{{ appointment.time|time:"g:i A" }}',
                    '{{ appointment.duration_minutes }}',
                    '{{ appointment.status|title }}',
                    '{{ appointment.student.user.get_full_name }}'
                )">
                ğŸ“„ View Details
              </button>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p style="text-align:center; opacity:0.7;">No history records found.</p>
      {% endif %}
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
        const timeFilter = document.getElementById('timeFilter');
        const statusFilter = document.getElementById('statusFilter');
        const cards = document.querySelectorAll('.booking-card');
        const countSpan = document.getElementById('visibleCount');

        function applyFilters() {
            const selectedTime = timeFilter.value;
            const selectedStatus = statusFilter.value;
            const today = new Date();
            let visibleCount = 0;

            cards.forEach(card => {
                const cardStatus = card.dataset.status;
                const cardDate = new Date(card.dataset.date);

                // 1. Check Status
                let statusMatch = (selectedStatus === 'all') || (cardStatus === selectedStatus);

                // 2. Check Time
                let timeMatch = true;
                if (selectedTime !== 'all') {
                    const daysAgo = parseInt(selectedTime);
                    const timeLimit = new Date();
                    timeLimit.setDate(today.getDate() - daysAgo);
                    timeMatch = cardDate >= timeLimit;
                }

                if (statusMatch && timeMatch) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            countSpan.textContent = visibleCount;
        }

        timeFilter.addEventListener('change', applyFilters);
        statusFilter.addEventListener('change', applyFilters);
    });

    const modal = document.getElementById("detailsModal");

    function openDetails(id, topic, date, time, duration, status, studentName) {
        const html = `
          <p><strong>Session ID:</strong> ${id}</p>
          <p><strong>Student:</strong> ${studentName}</p>
          <p><strong>Topic:</strong> ${topic}</p>
          <p><strong>Date:</strong> ${date}</p>
          <p><strong>Time:</strong> ${time}</p>
          <p><strong>Duration:</strong> ${duration} minutes</p>
          <p><strong>Final Status:</strong> ${status}</p>
        `;
        document.getElementById("detailsContent").innerHTML = html;
        modal.style.display = "flex";
    }

    function closeModal() {
        modal.style.display = "none";
    }

    window.onclick = function(e) {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    };
  </script>
</body>
</html>