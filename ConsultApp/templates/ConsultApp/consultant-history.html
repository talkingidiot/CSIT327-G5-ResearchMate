{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consultant â€” History</title>
  <link rel="stylesheet" href="{% static 'ConsultApp/student.css'%}">
  <link rel="stylesheet" href="{% static 'ConsultApp/consultant.css'%}">
  <link rel="stylesheet" href="{% static 'ConsultApp/consultant-dashboard.css'%}">
</head>
<body>
  <nav class="top-nav">
    <div class="logo">ResearchMate</div>
    
    <div class="nav-links">
      <a href="{% url 'consultant_dashboard' %}">ğŸ ï¸ Dashboard</a>
      <a href="{% url 'consultant_profile' %}">ğŸ‘¤ My Profile</a>
      <a href="{% url 'consultant_students' %}">ğŸ§‘â€ğŸ“ Students</a>
      <a href="{% url 'consultant_appointments' %}">ğŸ—“ Appointments</a>
      <a href="{% url 'consultant_history' %}" class="active">â± History</a>
    </div>

    <div class="user-section">
      <span class="consultant-label">Consultant</span>
      <form method="POST" action="{% url 'logout' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="logout-btn">âœ] Logout</button>
      </form>
    </div>
  </nav>

  <div id="detailsModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <h2>Appointment Details</h2>
      <div class="modal-content">
        <p><strong>Student:</strong> <span id="modalStudent"></span></p>
        <p><strong>Topic:</strong> <span id="modalTopic"></span></p>
        <p><strong>Date:</strong> <span id="modalDate"></span></p>
        <p><strong>Time:</strong> <span id="modalTime"></span></p>
        <p><strong>Duration:</strong> <span id="modalDuration"></span> minutes</p>
        <p><strong>Status:</strong> <span id="modalStatus"></span></p>
        <p id="modalRatingRow" style="display:none;"><strong>Student Rating:</strong> <span id="modalRating"></span></p>
      </div>
      <div class="modal-actions">
        <button class="btn-close" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <main class="main-content">
    
    {% if messages %}
      <div class="messages-container">
        {% for message in messages %}
          <div class="message {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
    
    <div class="page-header">
      <h1>Consultation History</h1>
      <p>View your completed and cancelled sessions</p>
    </div>

    <div class="filter-section">
      <div class="filter-controls">
        <select id="timeFilter">
          <option value="all">All Time</option>
          <option value="30">Last 30 days</option>
          <option value="90">Last 3 months</option>
          <option value="365">Last year</option>
        </select>

        <select id="statusFilter">
          <option value="all">All Statuses</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
          <option value="not_completed">Not Completed</option>
          <option value="rejected">Rejected by Consultant</option>
          <option value="pending_student_review">Pending Student Review</option>
          <option value="disputed">Pending Admin Review</option>
        </select>
      </div>
      <div class="results-count">
        Showing <span id="visibleCount">{{ appointments|length }}</span> past record(s)
      </div>
    </div>

    <div class="history-grid">
      {% if appointments %}
        {% for appointment in appointments %}
          <div class="booking-card" 
               data-status="{% if appointment.status == 'cancelled' and appointment.was_disputed %}not_completed{% else %}{{ appointment.status }}{% endif %}" 
               data-date="{{ appointment.date|date:'Y-m-d' }}">
            
            <div class="booking-header">
              <div class="consultant-info">
                <h3>{{ appointment.student.user.get_full_name }}</h3>
                <p class="specialty">{{ appointment.student.student_program|default:"Student" }}</p>
              </div>
              
              {% if appointment.status == 'completed' %}
                <span class="status-badge completed">ğŸ Completed</span>

              {% elif appointment.status == 'cancelled' %}
                {% if appointment.was_disputed %}
                  <span class="status-badge cancelled">âŒ Not Completed</span>
                {% else %}
                  <span class="status-badge cancelled">âŒ Cancelled by Student</span>
                {% endif %}

              {% elif appointment.status == 'rejected' %}
                <span class="status-badge cancelled">ğŸš« Rejected by You</span>

              {% elif appointment.status == 'pending_student_review' %}
                <span class="status-badge pending-review">â³ Pending Student Review</span>

              {% elif appointment.status == 'disputed' %}
                <span class="status-badge disputed">âš ï¸ Pending Admin Review</span>
              {% endif %}
            </div>

            <div class="booking-details">
              <div class="detail-row">
                <span class="label">Purpose:</span>
                <span class="value">{{ appointment.topic }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Date:</span>
                <span class="value">{{ appointment.date|date:"M d, Y" }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Time:</span>
                <span class="value">{{ appointment.time|time:"g:i A" }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Duration:</span>
                <span class="value">{{ appointment.duration_minutes }} minutes</span>
              </div>
              
              {% if appointment.status == 'completed' and appointment.feedback %}
                <div class="detail-row" style="border-top: 2px solid #e8f5e9; margin-top: 12px; padding-top: 12px;">
                  <span class="label">Student Rating:</span>
                  <span class="value" style="color: #f39c12; font-weight: 700;">
                    â­ {{ appointment.feedback.rating }}/5
                  </span>
                </div>
                {% if appointment.feedback.comment %}
                  <div class="detail-row">
                    <span class="label">Feedback:</span>
                    <span class="value" style="font-style: italic; color: #555; font-size: 13px;">
                      "{{ appointment.feedback.comment|truncatewords:15 }}"
                    </span>
                  </div>
                {% endif %}
              {% endif %}
              
              {% if appointment.status == 'pending_student_review' %}
                <div class="detail-row">
                  <span class="label">You marked as:</span>
                  <span class="value">
                    {% if appointment.consultant_marked_as == 'completed' %}
                      âœ… Completed
                    {% else %}
                      âŒ Not Completed
                    {% endif %}
                  </span>
                </div>
              {% endif %}
              
              {% if appointment.status == 'disputed' %}
                <div class="detail-row" style="border-top: 1px solid #eee; margin-top: 8px; padding-top: 8px;">
                  <span class="label">You marked as:</span>
                  <span class="value">
                    {% if appointment.consultant_marked_as == 'completed' %}
                      âœ… Completed
                    {% else %}
                      âŒ Not Completed
                    {% endif %}
                  </span>
                </div>
                <div class="detail-row">
                  <span class="label">Student's Dispute:</span>
                  <span class="value" style="color: #d32f2f; font-style: italic;">
                    "{{ appointment.student_dispute_remark }}"
                  </span>
                </div>
                <div class="detail-row">
                  <span class="value" style="color: #856404; font-size: 13px; background: #fff3cd; padding: 6px 10px; border-radius: 4px;">
                    â³ Admin is reviewing this case
                  </span>
                </div>
              {% endif %}
            </div>

            <div class="booking-actions">
              <button class="btn-details"
                onclick="openDetails(this)"
                data-student="{{ appointment.student.user.get_full_name }}"
                data-topic="{{ appointment.topic }}"
                data-date="{{ appointment.date|date:'M d, Y' }}"
                data-time="{{ appointment.time|time:'g:i A' }}"
                data-duration="{{ appointment.duration_minutes }}"
                data-status="{% if appointment.status == 'completed' %}Completed{% elif appointment.status == 'cancelled' and appointment.was_disputed %}Not Completed{% elif appointment.status == 'cancelled' %}Cancelled by Student{% elif appointment.status == 'rejected' %}Rejected by You{% elif appointment.status == 'pending_student_review' %}Pending Student Review{% elif appointment.status == 'disputed' %}Pending Admin Review{% else %}{{ appointment.status|title }}{% endif %}"
                data-rating="{% if appointment.feedback %}{{ appointment.feedback.rating }}{% endif %}"
                data-has-rating="{% if appointment.status == 'completed' and appointment.feedback %}true{% else %}false{% endif %}">
                ğŸ“„ View Details
              </button>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p style="text-align:center; opacity:0.7;">No history records found.</p>
      {% endif %}
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
        const timeFilter = document.getElementById('timeFilter');
        const statusFilter = document.getElementById('statusFilter');
        const cards = document.querySelectorAll('.booking-card');
        const countSpan = document.getElementById('visibleCount');

        function applyFilters() {
            const selectedTime = timeFilter.value;
            const selectedStatus = statusFilter.value;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let visibleCount = 0;

            cards.forEach(card => {
                const cardStatus = card.dataset.status;
                const dateStr = card.dataset.date;
                
                const cardDate = new Date(dateStr);
                
                if (isNaN(cardDate.getTime())) {
                    console.error('Invalid date:', dateStr);
                    card.style.display = 'none';
                    return;
                }
                
                cardDate.setHours(0, 0, 0, 0);

                let statusMatch = (selectedStatus === 'all') || (cardStatus === selectedStatus);

                let timeMatch = true;
                if (selectedTime !== 'all') {
                    const daysAgo = parseInt(selectedTime);
                    const timeLimit = new Date(today);
                    timeLimit.setDate(today.getDate() - daysAgo);
                    timeLimit.setHours(0, 0, 0, 0);
                    
                    timeMatch = cardDate >= timeLimit && cardDate <= today;
                }

                if (statusMatch && timeMatch) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            countSpan.textContent = visibleCount;
        }

        timeFilter.addEventListener('change', applyFilters);
        statusFilter.addEventListener('change', applyFilters);
    });

    const modal = document.getElementById("detailsModal");

    function openDetails(btn) {
        document.getElementById("modalStudent").textContent = btn.dataset.student;
        document.getElementById("modalTopic").textContent = btn.dataset.topic;
        document.getElementById("modalDate").textContent = btn.dataset.date;
        document.getElementById("modalTime").textContent = btn.dataset.time;
        document.getElementById("modalDuration").textContent = btn.dataset.duration;
        document.getElementById("modalStatus").textContent = btn.dataset.status;
        
        const hasRating = btn.dataset.hasRating === 'true';
        const ratingRow = document.getElementById("modalRatingRow");
        
        if (hasRating) {
            const rating = btn.dataset.rating;
            document.getElementById("modalRating").innerHTML = `â­ ${rating}/5`;
            ratingRow.style.display = 'block';
        } else {
            ratingRow.style.display = 'none';
        }
        
        modal.style.display = "flex";
    }

    function closeModal() {
        modal.style.display = "none";
    }

    window.onclick = function(e) {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    };
  </script>
</body>
</html>