{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book Appointment â€” ResearchMate</title>
  <link rel="stylesheet" href="{% static 'ConsultApp/admin-dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'ConsultApp/profile.css' %}">
  <link rel="stylesheet" href="{% static 'ConsultApp/book.css' %}">
  <style>
    .available-days {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .day-badge {
      padding: 4px 12px;
      background: #e6ffed;
      color: #38a169;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <nav class="top-nav">
    <div class="logo">ResearchMate</div>
    
    <div class="nav-links">
      <a href="{% url 'student_dashboard' %}">ğŸ  Dashboard</a>
      <a href="{% url 'student_profile' %}">ğŸ‘¤ Profile</a>
      <a href="{% url 'student_appointments' %}" class="active">ğŸ“… Appointments</a>
      <a href="{% url 'student_history' %}">ğŸ“œ History</a>
    </div>

    <div class="user-section">
      <span class="student-label">Student</span>
      <form method="POST" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="logout-btn">ğŸšª Logout</button>
      </form>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <div class="page-header">
      <h1>ğŸ“… Book a Research Consultant</h1>
      <p>Choose a verified consultant and schedule your appointment</p>
    </div>

    <!-- ERROR/SUCCESS MESSAGES -->
    {% if messages %}
      <div style="max-width: 900px; margin: 0 auto 20px;">
        {% for message in messages %}
          <div class="{% if message.tags == 'success' %}success-message{% else %}error-message{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Booking Layout -->
    <div class="profile-grid">
      <!-- Consultant Info Card (Left Side) -->
      <div class="profile-card">
        <h3>ğŸ“‹ Consultant Information</h3>
        {% if consultant and market %}
          <div class="consultant-card">
            <img src="{% static 'ConsultApp/default-profile.png' %}" alt="Consultant">
            <h4>{{ consultant.user.get_full_name }}</h4>
            <p><strong>Expertise:</strong> {{ market.expertise }}</p>
            <p><strong>Profession:</strong> {{ market.profession }}</p>
            <p><strong>Rate:</strong> â‚±{{ market.rate_per_hour }}/hour</p>
            <p><strong>Available Hours:</strong> {{ market.available_from|time:"g:i A" }} - {{ market.available_to|time:"g:i A" }}</p>
            
            {% if market.available_days %}
            <p><strong>Available Days:</strong></p>
            <div class="available-days">
              {% for day in market.get_available_days_list %}
                <span class="day-badge">{{ day|title }}</span>
              {% endfor %}
            </div>
            {% endif %}
            
            <p style="margin-top: 12px;"><strong>Location:</strong> {{ market.meeting_place }}</p>
            {% if market.description %}
              <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">{{ market.description }}</p>
            {% endif %}
          </div>
        {% elif consultants %}
          <p>Select a consultant from the dropdown to see their details.</p>
        {% else %}
          <p>No verified consultants available at the moment.</p>
        {% endif %}
      </div>

      <!-- Booking Form (Right Side) -->
      <div class="form-card">
        <h2>Appointment Details</h2>
        
        <!-- FORM ACTION MUST BE CORRECT -->
        <form method="POST" action="{% if consultant %}{% url 'book_appointment_with_consultant' consultant.user.id %}{% else %}{% url 'book_appointment' %}{% endif %}">
          {% csrf_token %}
          
          <!-- Consultant Selection -->
          {% if consultant %}
            <div class="form-group">
              <label>Consultant</label>
              <input type="text" value="{{ consultant.user.get_full_name }}" disabled>
            </div>
          {% else %}
            <div class="form-group">
              <label for="consultant_id">Select Consultant *</label>
              <select name="consultant_id" id="consultant_id" required>
                <option value="">-- Choose Consultant --</option>
                {% for c in consultants %}
                  <option value="{{ c.user.id }}">{{ c.user.get_full_name }} â€” {{ c.expertise }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}

          <!-- Topic -->
          <div class="form-group">
            <label for="topic">Consultation Topic *</label>
            <input type="text" name="topic" id="topic" placeholder="e.g., Research Methodology, Data Analysis" required>
          </div>

          <!-- Research Title (Optional) -->
          <div class="form-group">
            <label for="research_title">Research Title (Optional)</label>
            <input type="text" name="research_title" id="research_title" placeholder="Your research title">
          </div>

          <!-- Date -->
          <div class="form-group">
            <label for="date">Date *</label>
            <input type="date" name="date" id="date" required min="{{ today }}">
            {% if market and market.available_days %}
            <small style="color: #666; display: block; margin-top: 4px;">
              Available on: 
              {% for day in market.get_available_days_list %}
                {{ day|title }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </small>
            {% endif %}
          </div>

          <!-- Time Selection -->
          <div class="form-group">
            <label for="start_time">Start Time *</label>
            {% if slots %}
              <select name="start_time" id="start_time" required>
                <option value="">-- Select Time --</option>
                {% for slot in slots %}
                  <option value="{{ slot }}">{{ slot }}</option>
                {% endfor %}
              </select>
            {% else %}
              <input type="time" name="start_time" id="start_time" required>
            {% endif %}
            {% if market %}
              <small style="color: #666; display: block; margin-top: 4px;">
                Available: {{ market.available_from|time:"g:i A" }} - {{ market.available_to|time:"g:i A" }}
              </small>
            {% endif %}
          </div>

          <!-- Duration -->
          <div class="form-group">
            <label for="duration_hours">Duration *</label>
            <select id="duration_hours" name="duration_hours" required>
              <option value="1">1 hour</option>
              <option value="2">2 hours</option>
              <option value="3">3 hours</option>
            </select>
          </div>

          <!-- Total Cost Display -->
          {% if market %}
          <div class="form-group">
            <label>Estimated Total Cost:</label>
            <div id="total-cost-display" style="font-weight: bold; color: #1f3327; font-size: 1.25rem;">
              â‚±{{ market.rate_per_hour }}.00
            </div>
          </div>
          {% endif %}

          <!-- Form Actions -->
          <div class="form-actions">
            <button type="submit" class="btn-primary">ğŸ“… Submit Booking Request</button>
            <button type="button" class="btn-secondary" onclick="window.location.href='{% url 'student_dashboard' %}'">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    {% if market %}
    const ratePerHour = {{ market.rate_per_hour|default:0 }};
    const durationSelect = document.getElementById("duration_hours");
    const totalCostDisplay = document.getElementById("total-cost-display");

    function updateTotalCost() {
      const duration = parseFloat(durationSelect.value || 1);
      const total = ratePerHour * duration;
      totalCostDisplay.textContent = "â‚±" + total.toFixed(2);
    }

    if (durationSelect && totalCostDisplay) {
      durationSelect.addEventListener("change", updateTotalCost);
      updateTotalCost();
    }

    // Format time select options to 12-hour format
    const timeSelect = document.getElementById('start_time');
    if (timeSelect && timeSelect.tagName === 'SELECT') {
      const options = timeSelect.querySelectorAll('option');
      options.forEach(option => {
        if (option.value) {
          const time = option.value;
          const parts = time.split(':');
          let hours = parseInt(parts[0]);
          const minutes = parts[1];
          const ampm = hours >= 12 ? 'PM' : 'AM';
          hours = hours % 12 || 12;
          option.textContent = `${hours}:${minutes} ${ampm}`;
        }
      });
    }

    // Disable unavailable dates
    {% if unavailable_dates %}
    const unavailableDates = {{ unavailable_dates|safe }};
    const dateInput = document.getElementById('date');
    
    if (dateInput) {
      dateInput.addEventListener('input', function() {
        const selectedDate = this.value;
        if (unavailableDates.includes(selectedDate)) {
          alert('This consultant is not available on the selected date. Please choose another date.');
          this.value = '';
        }
      });
    }
    {% endif %}
    {% endif %}
  </script>
</body>
</html>