{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book Appointment â€” ResearchMate</title>
  <link rel="stylesheet" href="{% static 'ConsultApp/appointment.css' %}">
</head>
<body>
  <nav class="top-nav">
    <div class="logo">ResearchMate</div>
    
    <div class="nav-links">
      <a href="{% url 'student_dashboard' %}">ğŸ  Dashboard</a>
      <a href="{% url 'student_profile' %}">ğŸ‘¤ Profile</a>
      <a href="{% url 'student_appointments' %}" class="active">ğŸ“… Appointments</a>
      <a href="{% url 'student_history' %}">ğŸ“œ History</a>
    </div>

    <div class="user-section">
      <span class="student-label">Student</span>
      <form method="POST" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="logout-btn">ğŸšª Logout</button>
      </form>
    </div>
  </nav>

  <main class="main-content">
    <div class="page-header">
      <h1>ğŸ“… Book a Research Consultant</h1>
      <p>Choose a verified consultant and schedule your appointment</p>
    </div>

    {% if messages %}
      <div style="max-width: 900px; margin: 0 auto 20px;">
        {% for message in messages %}
          <div class="{% if message.tags == 'success' %}success-message{% else %}error-message{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="profile-grid">
      <div class="profile-card">
        <h3>ğŸ“‹ Consultant Information</h3>
        
        {% if consultant and market %}
          <div class="consultant-avatar-wrapper">
            {% if consultant.avatar_url %}
              <img src="{{ consultant.avatar_url }}" 
                  alt="{{ consultant.user.get_full_name }}" 
                  class="consultant-avatar-img">
            {% else %}
              <div class="consultant-initials">
                {{ consultant.user.first_name|first|upper }}{{ consultant.user.last_name|first|upper }}
              </div>
            {% endif %}
          </div>
          
          <div style="margin-bottom: 20px;">
              <h4 style="color: var(--navy); font-size: 18px; margin: 0;">{{ consultant.user.get_full_name }}</h4>
              <span class="role">{{ market.profession }}</span>
          </div>

          <div class="info-item">
            <div class="info-label">Expertise</div>
            <div class="info-value">{{ market.expertise }}</div>
          </div>

          <div class="info-item">
            <div class="info-label">Hourly Rate</div>
            <div class="info-value">â‚±{{ market.rate_per_hour }}/hour</div>
          </div>

          <div class="info-item">
            <div class="info-label">Available Hours</div>
            <div class="info-value">
              {{ market.available_from|time:"g:i A" }} - {{ market.available_to|time:"g:i A" }}
            </div>
          </div>

          {% if market.available_days %}
          <div class="info-item">
            <div class="info-label">Available Days</div>
            <div class="info-value" style="margin-top: 5px;">
              <div class="available-days">
                {% for day in market.get_available_days_list %}
                  <span class="day-badge">{{ day|title }}</span>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endif %}

          <div class="info-item">
            <div class="info-label">Location</div>
            <div class="info-value">{{ market.meeting_place }}</div>
          </div>

        {% elif consultants %}
          <p style="color: var(--text-muted); padding-top: 20px;">Select a consultant from the dropdown to see their details.</p>
        {% else %}
          <p style="color: var(--text-muted); padding-top: 20px;">No verified consultants available at the moment.</p>
        {% endif %}
      </div>

      <div class="form-card">
        <h2>Appointment Details</h2>
        
        <form method="POST" action="{% if consultant %}{% url 'book_appointment_with_consultant' consultant.user.id %}{% else %}{% url 'book_appointment' %}{% endif %}">
          {% csrf_token %}
          
          {% if consultant %}
            <div class="form-group">
              <label>Consultant</label>
              <input type="text" value="{{ consultant.user.get_full_name }}" disabled>
              <input type="hidden" name="consultant_id" value="{{ consultant.user.id }}">
              <small style="display:block; margin-top:5px;">
                <a href="{% url 'book_appointment' %}" style="color: var(--navy); text-decoration: underline;">Change Consultant</a>
              </small>
            </div>
          {% else %}
            <div class="form-group">
              <label for="consultant_id">Select Consultant *</label>
              <select name="consultant_id" id="consultant_id" required onchange="loadConsultantDetails(this)">
                <option value="">-- Choose Consultant --</option>
                {% for c in consultants %}
                  <option value="{{ c.user.id }}">{{ c.user.get_full_name }} â€” {{ c.expertise }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}

          <div class="form-group">
            <label for="topic">Consultation Topic *</label>
            <input type="text" name="topic" id="topic" placeholder="e.g., Research Methodology, Data Analysis" required>
          </div>

          <div class="form-group">
            <label for="research_title">Research Title (Optional)</label>
            <input type="text" name="research_title" id="research_title" placeholder="Your research title">
          </div>

          <div class="form-group">
            <label for="date">Date *</label>
            <input type="date" name="date" id="date" required min="{{ tomorrow }}">
            {% if market and market.available_days %}
            <small style="color: #666; display: block; margin-top: 4px;">
              Available on: 
              {% for day in market.get_available_days_list %}
                {{ day|title }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </small>
            {% endif %}
          </div>

          <div class="form-group">
            <label for="start_time">Start Time *</label>
            {% if slots %}
              <select name="start_time" id="start_time" required>
                <option value="">-- Select Time --</option>
                {% for slot in slots %}
                  <option value="{{ slot }}">{{ slot }}</option>
                {% endfor %}
              </select>
            {% else %}
              <input type="time" name="start_time" id="start_time" required>
            {% endif %}
            {% if market %}
              <small style="color: #666; display: block; margin-top: 4px;">
                Available: {{ market.available_from|time:"g:i A" }} - {{ market.available_to|time:"g:i A" }}
              </small>
            {% endif %}
          </div>

          <div class="form-group">
            <label for="duration_hours">Duration *</label>
            <select id="duration_hours" name="duration_hours" required>
              <option value="1">1 hour</option>
              <option value="2">2 hours</option>
              <option value="3">3 hours</option>
            </select>
          </div>

          {% if market %}
          <div class="form-group">
            <label>Estimated Total Cost:</label>
            <div id="total-cost-display" style="font-weight: bold; color: #1f3327; font-size: 1.25rem;">
              â‚±{{ market.rate_per_hour }}.00
            </div>
          </div>
          {% endif %}

          <div class="form-actions">
            <button type="submit" class="btn-primary">ğŸ“… Submit Booking Request</button>
            <button type="button" class="btn-secondary" onclick="window.location.href='{% url 'student_dashboard' %}'">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    function loadConsultantDetails(selectElement) {
        const consultantId = selectElement.value;
        if (consultantId) {
          const baseUrl = "{% url 'book_appointment' %}"; 
          
          const cleanBaseUrl = baseUrl.endsWith('/') ? baseUrl : baseUrl + '/';
          
          window.location.href = cleanBaseUrl + consultantId + "/";
        }
    }

    {% if market %}
    const ratePerHour = {{ market.rate_per_hour|default:0 }};
    const durationSelect = document.getElementById("duration_hours");
    const totalCostDisplay = document.getElementById("total-cost-display");

    function updateTotalCost() {
      const duration = parseFloat(durationSelect.value || 1);
      const total = ratePerHour * duration;
      totalCostDisplay.textContent = "â‚±" + total.toFixed(2);
    }

    if (durationSelect && totalCostDisplay) {
      durationSelect.addEventListener("change", updateTotalCost);
      updateTotalCost();
    }

    const timeSelect = document.getElementById('start_time');
    if (timeSelect && timeSelect.tagName === 'SELECT') {
      const options = timeSelect.querySelectorAll('option');
      options.forEach(option => {
        if (option.value) {
          const time = option.value;
          const parts = time.split(':');
          let hours = parseInt(parts[0]);
          const minutes = parts[1];
          const ampm = hours >= 12 ? 'PM' : 'AM';
          hours = hours % 12 || 12; 
          option.textContent = `${hours}:${minutes} ${ampm}`;
        }
      });
    }
    {% endif %}
  </script>
</body>
</html>