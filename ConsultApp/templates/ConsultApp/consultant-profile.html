{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ResearchMate ‚Äî Consultant Profile</title>
  <link rel="stylesheet" href="{% static 'ConsultApp/consultant-dashboard.css'%}">
  <link rel="stylesheet" href="{% static 'ConsultApp/consultant-profile.css'%}">
</head>
<body>
  <nav class="top-nav">
    <div class="logo">ResearchMate</div>
    
    <div class="nav-links">
      <a href="{% url 'consultant_dashboard' %}">üè† Dashboard</a>
      <a href="{% url 'consultant_profile' %}" class="active">üë§ My Profile</a>
      <a href="{% url 'consultant_students' %}">üßë‚Äçüéì Students</a>
      <a href="{% url 'consultant_appointments' %}">üìÖ Appointments</a>
      <a href="{% url 'consultant_history' %}">üìú History</a>
    </div>

    <div class="user-section">
      <span class="consultant-label">Consultant</span>
      <form method="POST" action="{% url 'logout' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="logout-btn">üö™ Logout</button>
      </form>
    </div>
  </nav>
    
  <main class="main-content">
    
    <div class="page-header">
      <h1>Consultant Profile</h1>
      <p>Update your information to be displayed in your dashboard</p>
    </div>

    <div class="profile-progress-container">
      <h3>Profile Completion</h3>

      <div class="progress-bar">
          <div class="progress-fill" style="width: {{ completion_percentage }}%;"></div>
      </div>

      <p class="progress-text">{{ completion_percentage }}% complete</p>

      {% if missing_fields %}
        <ul class="missing-fields">
          {% for f in missing_fields %}
            <li>‚ö† {{ f }} not completed</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>

    <div class="profile-grid">
      <div class="profile-card">
        <div class="avatar-wrapper">
            <img 
              src="{{ avatar_url|default:'' }}" 
              alt="Profile" 
              class="profile-avatar-img"
              id="userAvatarImg"
              style="{% if not avatar_url %}display: none;{% endif %}"
              onerror="
                this.style.display='none'; 
                document.getElementById('initialsAvatar').style.display='flex'; 
                document.getElementById('removeAvatarSection').style.display='none';
              ">
              <div class="profile-avatar" id="initialsAvatar" style="{% if avatar_url %}display: none;{% endif %}">
                {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
              </div>
        </div>
        <h3>{{ user.first_name }} {{ user.last_name }}</h3>
        <p class="role" style="color: #666; margin-bottom: 20px;">Research Consultant</p>

        <div class="info-item" style="width: 100%; text-align: left;">
          <div class="info-label">Email</div>
          <div class="info-value">{{ user.email }}</div>
        </div>

        <div class="info-item" style="width: 100%; text-align: left;">
          <div class="info-label">Contact</div>
          <div class="info-value">{{ profile.contact_number|default:"Not set" }}</div>
        </div>

        <div class="info-item" style="width: 100%; text-align: left;">
          <div class="info-label">Expertise</div>
          <div class="info-value">{{ profile.expertise|default:"Not set" }}</div>
        </div>
      </div>

      <div class="form-card">
        <div class="header-row">
          <h2>Profile Information</h2>
          <button type="button" id="editBtn" class="btn-primary" onclick="enableEditing()">
            Edit Profile
          </button>
        </div>
        
        {% if messages %}
            {% for message in messages %}
                {% if 'success' in message.tags or 'general_error' in message.tags %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endif %}
            {% endfor %}
        {% endif %}

        <form method="POST" id="profileForm" enctype="multipart/form-data">
          {% csrf_token %}

          <fieldset id="formFields" disabled style="border: none; padding: 0; margin: 0;">
              
              <div class="avatar-upload-container" id="avatarUploadField">
                <label for="avatar_upload">Update Profile Picture</label>
                <input type="file" name="avatar_upload" id="avatar_upload" accept="image/*">
                <small style="display:block; color: #666; margin-top:5px;">Max size: 2MB</small>

                <div id="removeAvatarSection" style="margin-top: 12px; border-top: 1px solid #e2e8f0; padding-top: 10px;">
                  <button type="submit" name="remove_avatar" value="true" class="btn-remove-photo" onclick="return confirm('Are you sure you want to remove your profile photo?');">
                    Remove Current Photo
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label for="fullName">Full Name</label>
                <input type="text" id="fullName" name="full_name" value="{{ user.first_name }} {{ user.last_name }}">
                {% for message in messages %}
                    {% if 'full_name_error' in message.tags %}
                        <small class="error-text">‚ö† {{ message }}</small>
                    {% endif %}
                {% endfor %}
              </div>

              <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" value="{{ user.email }}">
                {% for message in messages %}
                    {% if 'email_error' in message.tags %}
                        <small class="error-text">‚ö† {{ message }}</small>
                    {% endif %}
                {% endfor %}
              </div>
              
              <div class="form-group">
                <label for="contactNumber">Contact Number (Philippines)</label>
                <input type="tel" id="contactNumber" name="contact_number" placeholder="09XXXXXXXXX (11 digits)" value="{{ profile.contact_number|default_if_none:'' }}">
                {% for message in messages %}
                    {% if 'contact_number_error' in message.tags %}
                        <small class="error-text">‚ö† {{ message }}</small>
                    {% endif %}
                {% endfor %}
              </div>

              <div class="form-group">
                <label>Expertise / Specialization</label>
                <input type="text" id="expertiseViewMode" value="{{ profile.expertise|default:'' }}" placeholder="Not set" disabled>
                  <div id="expertiseEditMode" class="expertise-grid-container" style="display: none; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 5px;">
                    {% for option in expertise_options %}
                      <label class="expertise-option-card" style="display: flex; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; background: #fff;">
                        <input type="checkbox" name="expertise" value="{{ option }}" 
                          style="margin-right: 10px; width: 18px; height: 18px;"
                          {% if option in current_expertise_list %}checked{% endif %}>
                        <span style="font-size: 0.95rem;">{{ option }}</span>
                      </label>
                    {% endfor %}
                  </div>
                {% for message in messages %}
                  {% if 'expertise_error' in message.tags %}
                    <small class="error-text">‚ö† {{ message }}</small>
                  {% endif %}
                {% endfor %}
              </div>

              <div class="form-group">
                <label for="workplace">Workplace</label>
                <input type="text" id="workplace" name="workplace" placeholder="Not set" value="{{ profile.workplace|default_if_none:'' }}">
                {% for message in messages %}
                    {% if 'workplace_error' in message.tags %}
                        <small class="error-text">‚ö† {{ message }}</small>
                    {% endif %}
                {% endfor %}
              </div>
          </fieldset>

          <div class="form-actions" id="actionButtons" style="display: none; margin-top: 20px;">
            <button type="submit" class="btn-primary">Save Changes</button>
            <button type="button" class="btn-secondary" onclick="cancelEditing()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </main>
  
  <script>
    function enableEditing() {
      document.getElementById('editBtn').style.display = 'none';
      document.getElementById('actionButtons').style.display = 'flex';
      document.getElementById('formFields').disabled = false;
      document.getElementById('avatarUploadField').style.display = 'block';
      document.getElementById('expertiseViewMode').style.display = 'none';
      document.getElementById('expertiseEditMode').style.display = 'grid'; 
      const checkboxes = document.querySelectorAll('input[name="expertise"]');
      checkboxes.forEach(cb => cb.disabled = false);
    }

    function cancelEditing() {
      document.getElementById('editBtn').style.display = 'block';
      document.getElementById('actionButtons').style.display = 'none';
      document.getElementById('formFields').disabled = true;
      document.getElementById('avatarUploadField').style.display = 'none';
      document.getElementById('expertiseViewMode').style.display = 'block';
      document.getElementById('expertiseEditMode').style.display = 'none';
      window.location.reload(); 
    }
    
    document.getElementById('contactNumber').addEventListener('input', function(e) {
      this.value = this.value.replace(/[^0-9]/g, '');
    });
    
    {% if messages %}
        {% for message in messages %}
            {% if 'error' in message.tags %}
              enableEditing();
            {% endif %}
        {% endfor %}
    {% endif %}
  </script>
</body>
</html>