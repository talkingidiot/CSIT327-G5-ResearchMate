{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ResearchMate â€” Student Dashboard</title>
  <link rel="stylesheet" href="{% static 'ConsultApp/student-dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'ConsultApp/card-grid.css' %}">
</head>
<body>
  <nav class="top-nav">
    <div class="logo">ResearchMate</div>
    
    <div class="nav-links">
      <a href="{% url 'student_dashboard' %}" class="active">ğŸ ï¸ Dashboard</a>
      <a href="{% url 'student_profile' %}">ğŸ‘¤ Profile</a>
      <a href="{% url 'student_appointments' %}">ğŸ—“ Appointments</a>
      <a href="{% url 'student_history' %}">â± History</a>
    </div>

    <div class="user-section">
      <span class="student-label">Student</span>
      <form method="POST" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="logout-btn">âœ] Logout</button>
      </form>
    </div>
  </nav>

  <main class="main-content">
    <header class="page-header">
      <h1>Welcome back, <span id="welcomeName">{{ student_name }}</span>!</h1>
      <p>Find a research consultant and manage your bookings</p>
    </header>

    {% if messages %}
      <div style="margin-bottom: 20px;">
        {% for message in messages %}
          <div style="padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; 
                      {% if message.tags == 'success' %}background: #d4edda; color: #155724; border: 1px solid #c3e6cb;
                      {% elif message.tags == 'error' %}background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
                      {% else %}background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% if pending_reviews %}
    <div class="pending-review-alert">
      <h3>âš ï¸ Action Required: {{ pending_reviews|length }} Meeting{% if pending_reviews|length > 1 %}s{% endif %} Pending Your Review</h3>
      <p style="margin: 0 0 16px 0; color: #856404;">
        Your consultant has marked the following meeting{{ pending_reviews|length|pluralize }} as completed or not completed. 
        Please confirm or dispute the status.
      </p>
      
      {% for appointment in pending_reviews %}
      <div class="pending-review-item">
        <div class="review-header">
          <div class="review-info">
            <h4>{{ appointment.consultant.user.get_full_name }}</h4>
            <p><strong>Topic:</strong> {{ appointment.topic }}</p>
            <p><strong>Date:</strong> {{ appointment.date|date:"M d, Y" }} at {{ appointment.time|time:"g:i A" }}</p>
          </div>
          <div class="consultant-marked {% if appointment.consultant_marked_as == 'completed' %}marked-completed{% else %}marked-not-completed{% endif %}">
            {% if appointment.consultant_marked_as == 'completed' %}
              âœ… Marked as Completed
            {% else %}
              âŒ Marked as Not Completed
            {% endif %}
          </div>
        </div>
        
        <div class="review-actions">
          <form action="{% url 'student_confirm_or_dispute' appointment.id %}" method="POST" style="display: inline;">
            {% csrf_token %}
            <input type="hidden" name="action" value="confirm">
            <button type="submit" class="btn-quick-confirm">âœ… Confirm</button>
          </form>
          <a href="{% url 'student_appointments' %}?review={{ appointment.id }}" class="btn-quick-view">ğŸ“‹ View & Dispute</a>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <div class="dashboard-grid">
      <section>
        <div class="search-card">
          <h2>ğŸ”ï¸ Find Your Research Consultant</h2>
          <form method="GET" class="search-box">
            <input 
                type="text" 
                name="q" 
                value="{{ query }}" 
                placeholder="Search by name, subject, or expertise..."/>
            <button type="submit">Search</button>
          </form>
          <p>Connect with available consultants and schedule a session.</p>
        </div>

        <div class="stats-grid">
          <div class="stat-box"><h4>Current</h4><div class="number">{{ stats.current }}</div></div>
          <div class="stat-box"><h4>Previous</h4><div class="number">{{ stats.previous }}</div></div>
          <div class="stat-box"><h4>Pending</h4><div class="number">{{ stats.pending }}</div></div>
          <div class="stat-box"><h4>Cancelled</h4><div class="number">{{ stats.cancelled }}</div></div>
        </div>

        <section class="consultants-section">
          <h2>Recommended Consultants</h2>
          {% if recommended_consultants %}
            <div class="consultants-grid">
              {% for market in recommended_consultants %}
                <div class="consultant-card">
                  <div class="consultant-avatar-wrapper">
                    <img 
                      src="{{ market.consultant.avatar_url|default:'' }}" 
                      alt="{{ market.consultant.user.get_full_name }}"
                      class="consultant-avatar-img"
                      style="{% if not market.consultant.avatar_url %}display: none;{% endif %}"
                      onerror="this.style.display='none'"
                    >
                    
                    <div class="consultant-initials">
                      {{ market.consultant.user.first_name|slice:":1"|upper }}{{ market.consultant.user.last_name|slice:":1"|upper }}
                    </div>
                </div>
                  <h4>{{ market.consultant.user.get_full_name }}</h4>
                  <p>{{ market.consultant.expertise|default:"No expertise listed" }}</p>
                  <p class="rate">ğŸ’° â‚±{{ market.rate_per_hour }} / hour</p>
                  <p class="meeting">ğŸ“ {{ market.meeting_place }}</p>

                  <a href="{% url 'consultant_details' market.consultant.user.id %}" class="btn-view-details">
                    View Details
                  </a>
                  
                  <div style="margin-top: 8px;">
                    {% if market.consultant.user.id in pending_consultant_ids %}
                      <button type="button" 
                              class="btn-primary" 
                              {% comment %} style="width: 100%; display: inline-block; padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer;" {% endcomment %}
                              onclick="showPendingModal('{{ market.consultant.user.get_full_name|escapejs }}')">
                        Book Now
                      </button>
                    {% else %}
                      <a href="{% url 'book_appointment_with_consultant' market.consultant.user.id %}" 
                        class="btn-primary">
                        {% comment %} style="display: inline-block; width: 100%; padding: 10px 20px; background: #4caf50; color: white; text-decoration: none; border-radius: 8px; text-align: center; box-sizing: border-box;"> {% endcomment %}
                        Book Now
                      </a>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p>No consultants available yet.</p>
          {% endif %}
        </section>
      </section>

      <aside class="sidebar-column">
        <div class="profile-card">
          <div class="profile-header">
            <div class="dashboard-avatar-wrapper">
              <img 
                src="{{ avatar_url|default:'' }}" 
                alt="Profile" 
                class="dashboard-avatar-img"
                style="{% if not avatar_url %}display: none;{% endif %}"
                onerror="this.style.display='none'; document.getElementById('dashboardInitials').style.display='flex';"
              >

              <div class="profile-avatar" id="dashboardInitials" style="{% if avatar_url %}display: none;{% endif %}">
                {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
              </div>
            </div>
            <div class="profile-name">
              <h3 id="profileName">{{ student_name }}</h3>
              <p>Student</p>
            </div>
          </div>

          <div class="profile-info">
            <div class="info-row"><span class="label">Email:</span><span class="value">{{ request.user.email }}</span></div>
            <div class="info-row"><span class="label">Department:</span><span class="value">{{ student.student_department|default:"N/A" }}</span></div>
            <div class="info-row"><span class="label">Program:</span><span class="value">{{ student.student_program|default:"N/A" }}</span></div>
            <div class="info-row"><span class="label">Year Level:</span><span class="value">{{ student.student_year_level|default:"N/A" }}</span></div>
          </div>
        </div>

        <div class="sessions-card">
          <h2>Upcoming Sessions</h2>
          {% if upcoming_sessions %}
            {% for session in upcoming_sessions %}
              <div class="session-item">
                <div class="session-date">ğŸ“… {{ session.date|date:"M d, Y" }}</div>
                <div class="session-details">
                  <strong>{{ session.topic }}</strong><br>
                  Consultation with {{ session.consultant.user.get_full_name }} at {{ session.time|time:"g:i A" }}
                  <span style="display: inline-block; margin-top: 4px; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;
                        {% if session.status == 'pending' %}background: #fffbea; color: #d69e2e;
                        {% elif session.status == 'confirmed' %}background: #e6ffed; color: #38a169;
                        {% elif session.status == 'pending_student_review' %}background: #fff3cd; color: #856404;{% endif %}">
                    {% if session.status == 'pending_student_review' %}
                      âš ï¸ Review Needed
                    {% else %}
                      {{ session.get_status_display }}
                    {% endif %}
                  </span>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p>No upcoming sessions.</p>
          {% endif %}
        </div>
      </aside>
    </div>
  </main>
  <div id="dashboardPendingModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="modal-content" style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: fadeIn 0.2s;">
      <div style="font-size: 42px; margin-bottom: 15px;">â³</div>
      <h3 style="color: #001f54; margin-bottom: 10px; font-size: 1.25rem; font-weight: 700;">Pending Request</h3>
      <p style="color: #555; margin-bottom: 25px; line-height: 1.5; font-size: 0.95rem;">
        You already have a pending appointment with <strong id="modalConsultantName" style="color: #001f54;">this consultant</strong>. 
        <br><br>
        Please wait for them to accept or reject your current request before booking another session.
      </p>
      <button onclick="closeDashboardModal()" style="background: #001f54; color: white; border: none; padding: 10px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s;">
        Okay, Got it
      </button>
    </div>
  </div>
  <script>
    function showPendingModal(consultantName) {
      document.getElementById('modalConsultantName').innerText = consultantName;
      document.getElementById('dashboardPendingModal').style.display = 'flex';
    }

    function closeDashboardModal() {
      document.getElementById('dashboardPendingModal').style.display = 'none';
    }

    window.onclick = function(event) {
      const modal = document.getElementById('dashboardPendingModal');
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }
  </script>
</body>
</html>