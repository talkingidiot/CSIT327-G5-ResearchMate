{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ResearchMate â€” History</title>
  <link rel="stylesheet" href="{% static 'ConsultApp/student.css'%}">
  <link rel="stylesheet" href="{% static 'ConsultApp/student-dashboard.css'%}">
  <link rel="stylesheet" href="{% static 'ConsultApp/feedback.css'%}">
</head>
<body>
  <nav class="top-nav">
    <div class="logo">ResearchMate</div>
    
    <div class="nav-links">
      <a href="{% url 'student_dashboard' %}">ğŸ  Dashboard</a>
      <a href="{% url 'student_profile' %}">ğŸ‘¤ Profile</a>
      <a href="{% url 'student_appointments' %}">ğŸ“… Appointments</a>
      <a href="{% url 'student_history' %}" class="active">ğŸ“œ History</a>
    </div>

    <div class="user-section">
      <span class="student-label">Student</span>
      <form method="POST" action="{% url 'logout' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="logout-btn">ğŸšª Logout</button>
      </form>
    </div>
  </nav>

  <div id="detailsModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <h2>Session Details</h2>
      <div id="detailsContent"></div>
      <div class="modal-actions">
        <button class="btn-close" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <div id="feedbackModal" class="feedback-modal">
    <div class="feedback-content">
      <h2>Rate Your Session</h2>
      <p style="text-align: center; color: #666; margin-bottom: 10px;">
        How was your consultation with <strong id="consultantName"></strong>?
      </p>
      
      <div class="star-rating" id="starRating">
        <span class="star" data-rating="1">â˜†</span>
        <span class="star" data-rating="2">â˜†</span>
        <span class="star" data-rating="3">â˜†</span>
        <span class="star" data-rating="4">â˜†</span>
        <span class="star" data-rating="5">â˜†</span>
      </div>
      
      <textarea 
        id="feedbackComment" 
        class="feedback-comment" 
        placeholder="Share your experience (optional)..."
      ></textarea>
      
      <form method="POST" id="feedbackForm" action="{% url 'submit_feedback' %}">
        {% csrf_token %}
        <input type="hidden" name="appointment_id" id="appointmentId">
        <input type="hidden" name="rating" id="ratingValue">
        <input type="hidden" name="comment" id="commentValue">
        
        <div class="feedback-actions">
          <button type="button" class="btn-cancel-feedback" onclick="closeFeedbackModal()">Cancel</button>
          <button type="submit" class="btn-submit-feedback">Submit Feedback</button>
        </div>
      </form>
    </div>
  </div>

  <main class="main-content">
    
    <div class="page-header">
      <h1>Booking History</h1>
      <p>View your previous consultation sessions</p>
    </div>

    <div class="filter-section">
      <div class="filter-controls">
        <select id="timeFilter">
          <option value="all">All Time</option>
          <option value="30">Last 30 days</option>
          <option value="90">Last 3 months</option>
          <option value="365">Last year</option>
        </select>

        <select id="consultantFilter">
          <option value="all">All Consultants</option>
          {% for consultant in consultants %}
            <option value="{{ consultant.user.id }}">{{ consultant.user.get_full_name }}</option>
          {% endfor %}
        </select>
        
        <select id="statusFilter">
          <option value="all">All Statuses</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled by You</option>
          <option value="rejected">Rejected by Consultant</option>
          <option value="disputed">Pending Admin Review</option>
        </select>
      </div>
      <div class="results-count">
        Showing <span id="visibleCount">{{ appointments|length }}</span> result(s)
      </div>
    </div>

    <div class="history-grid">
      {% if appointments %}
        {% for appointment in appointments %}
          <div class="booking-card" 
               data-consultant="{{ appointment.consultant.user.id }}" 
               data-date="{{ appointment.date|date:'Y-m-d' }}"
               data-status="{{ appointment.status }}">
            
            <div class="booking-header">
              <div class="consultant-info">
                <h3>{{ appointment.consultant.user.get_full_name }}</h3>
                <p class="specialty">{{ appointment.consultant.expertise|default:"Consultant" }}</p>
              </div>
              
              {% if appointment.status == 'completed' %}
                <span class="status-badge completed">ğŸ Completed</span>
              {% elif appointment.status == 'cancelled' %}
                <span class="status-badge cancelled">âŒ Cancelled by You</span>
              {% elif appointment.status == 'rejected' %}
                <span class="status-badge cancelled">ğŸš« Rejected by Consultant</span>
              {% elif appointment.status == 'disputed' %}
                <span class="status-badge disputed">âš ï¸ Pending Admin Review</span>
              {% endif %}
            </div>

            <div class="booking-details">
              <div class="detail-row">
                <span class="label">Purpose:</span>
                <span class="value">{{ appointment.topic }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Date:</span>
                <span class="value">{{ appointment.date|date:"M d, Y" }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Duration:</span>
                <span class="value">{{ appointment.duration_minutes }} minutes</span>
              </div>
              
              {% if appointment.status == 'disputed' %}
                <div class="dispute-info-box">
                  <p><strong>â³ Status:</strong> Pending Admin Review</p>
                  <p><strong>Your dispute reason:</strong> "{{ appointment.student_dispute_remark }}"</p>
                  <p style="font-size: 12px; margin-top: 8px;">An administrator will review this case and make a final decision.</p>
                </div>
              {% endif %}
            </div>

            <div class="booking-actions">
              <button class="btn-details"
                onclick="openDetails(
                    '{{ appointment.id }}',
                    '{{ appointment.topic }}',
                    '{{ appointment.date|date:"M d, Y" }}',
                    '{{ appointment.time|time:"g:i A" }}',
                    '{{ appointment.duration_minutes }}',
                    '{{ appointment.status|title }}',
                    '{{ appointment.consultant.user.get_full_name }}'
                )">
                ğŸ“„ View Details
              </button>
              
              {% if appointment.status == 'completed' %}
                {% if appointment.feedback %}
                  <span class="feedback-given">â­ Feedback Given ({{ appointment.feedback.rating }}/5)</span>
                {% else %}
                  <button class="btn-feedback" 
                    onclick="openFeedbackModal(
                      '{{ appointment.id }}',
                      '{{ appointment.consultant.user.get_full_name }}'
                    )">â­ Give Feedback</button>
                {% endif %}
              {% elif appointment.status == 'disputed' %}
                <span style="font-size: 13px; color: #856404; background: #fff3cd; padding: 6px 12px; border-radius: 4px; display: inline-block;">
                  â³ Pending Admin Review
                </span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p style="text-align:center; opacity:0.7;">No history records found.</p>
      {% endif %}
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
        const timeFilter = document.getElementById('timeFilter');
        const consultantFilter = document.getElementById('consultantFilter');
        const statusFilter = document.getElementById('statusFilter');
        const cards = document.querySelectorAll('.booking-card');
        const countSpan = document.getElementById('visibleCount');

        function applyFilters() {
            const selectedTime = timeFilter.value;
            const selectedConsultant = consultantFilter.value;
            const selectedStatus = statusFilter.value;
            const today = new Date();
            let visibleCount = 0;

            cards.forEach(card => {
                const cardConsultantId = card.dataset.consultant;
                const cardDate = new Date(card.dataset.date);
                const cardStatus = card.dataset.status;

                let consultantMatch = (selectedConsultant === 'all') || (cardConsultantId === selectedConsultant);
                let statusMatch = (selectedStatus === 'all') || (cardStatus === selectedStatus);
                let timeMatch = true;

                if (selectedTime !== 'all') {
                    const daysAgo = parseInt(selectedTime);
                    const timeLimit = new Date();
                    timeLimit.setDate(today.getDate() - daysAgo);
                    timeMatch = cardDate >= timeLimit;
                }

                if (consultantMatch && timeMatch && statusMatch) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            countSpan.textContent = visibleCount;
        }

        timeFilter.addEventListener('change', applyFilters);
        consultantFilter.addEventListener('change', applyFilters);
        statusFilter.addEventListener('change', applyFilters);
    });

    const modal = document.getElementById("detailsModal");

    function openDetails(id, topic, date, time, duration, status, consultant) {
        const html = `
          <p><strong>Session ID:</strong> ${id}</p>
          <p><strong>Consultant:</strong> ${consultant}</p>
          <p><strong>Topic:</strong> ${topic}</p>
          <p><strong>Date:</strong> ${date}</p>
          <p><strong>Time:</strong> ${time}</p>
          <p><strong>Duration:</strong> ${duration} minutes</p>
          <p><strong>Final Status:</strong> ${status}</p>
        `;
        document.getElementById("detailsContent").innerHTML = html;
        modal.style.display = "flex";
    }

    function closeModal() {
        modal.style.display = "none";
    }

    window.onclick = function(e) {
        if (e.target === modal) {
            modal.style.display = "none";
        }
        if (e.target.id === 'feedbackModal') {
            closeFeedbackModal();
        }
    };

    const feedbackModal = document.getElementById('feedbackModal');
    const stars = document.querySelectorAll('.star');
    let selectedRating = 0;

    function openFeedbackModal(appointmentId, consultantName) {
        document.getElementById('appointmentId').value = appointmentId;
        document.getElementById('consultantName').textContent = consultantName;
        selectedRating = 0;
        updateStars(0);
        document.getElementById('feedbackComment').value = '';
        feedbackModal.style.display = 'flex';
    }

    function closeFeedbackModal() {
        feedbackModal.style.display = 'none';
    }

    function updateStars(rating) {
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
                star.textContent = 'â˜…';
            } else {
                star.classList.remove('active');
                star.textContent = 'â˜†';
            }
        });
    }

    stars.forEach(star => {
        star.addEventListener('click', function() {
            selectedRating = parseInt(this.dataset.rating);
            updateStars(selectedRating);
        });

        star.addEventListener('mouseenter', function() {
            const rating = parseInt(this.dataset.rating);
            updateStars(rating);
        });
    });

    document.getElementById('starRating').addEventListener('mouseleave', function() {
        updateStars(selectedRating);
    });

    document.getElementById('feedbackForm').addEventListener('submit', function(e) {
        if (selectedRating === 0) {
            e.preventDefault();
            alert('Please select a rating before submitting.');
            return;
        }
        document.getElementById('ratingValue').value = selectedRating;
        document.getElementById('commentValue').value = document.getElementById('feedbackComment').value;
    });
  </script>
</body>
</html>