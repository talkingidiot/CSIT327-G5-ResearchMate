{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ResearchMate â€” {% if market_listing %}Edit{% else %}Add{% endif %} Market Listing</title>
  <link rel="stylesheet" href="{% static 'ConsultApp/verification.css'%}">
</head>
<body>
  <nav class="top-nav">
    <div class="logo">ResearchMate</div>
    
    <div class="nav-links">
      <a href="{% url 'consultant_dashboard' %}">ğŸ ï¸ Dashboard</a>
      <a href="{% url 'consultant_profile' %}">ğŸ‘¤ My Profile</a>
      <a href="{% url 'consultant_students' %}">ğŸ§‘â€ğŸ“ Students</a>
      <a href="{% url 'consultant_appointments' %}">ğŸ—“ Appointments</a>
      <a href="{% url 'consultant_history' %}">â± History</a>
    </div>

    <div class="user-section">
      <span class="consultant-label">Consultant</span>
      <form method="POST" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="logout-btn">âœ] Logout</button>
      </form>
    </div>
  </nav>

  <main class="main-content">
    {% if messages %}
      <div class="alert">
        {% for message in messages %}
          <div style="padding: 10px; margin-bottom: 10px; border-radius: 5px; 
                      {% if 'success' in message.tags %}background:#d4edda;color:#155724;{% else %}background:#f8d7da;color:#721c24;{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="page-header">
      <div class="badge">ğŸ¯ Market Listing</div>
      <h1>{% if market_listing %}Edit Your{% else %}List Yourself in the{% endif %} Market</h1>
      <p>{% if market_listing %}Update your details so students can book consultations with you.{% else %}Fill in your details so students can book consultations with you.{% endif %}</p>
    </div>

    <div class="info-box">
      <h4>â„¹ï¸ Listing Guidelines</h4>
      <p>Only verified consultants can list their availability. Make sure to provide accurate information about your expertise, rate, and availability.</p>
    </div>

    <div class="form-card">
      <h2>ğŸ“‹ Market Listing Form</h2>
      
      <form id="marketForm" method="POST" action="{% url 'consultant_market' %}">
        {% csrf_token %}
        
        <div class="form-section">
          <h3>ğŸ’¼ Professional Details</h3>

          <div class="form-group">
            <label>Expertise / Specialization * (Select all that apply)</label>
            <div class="expertise-grid" id="expertiseGrid">
              {% for option in expertise_options %}
                <label class="expertise-option {% if option in submitted_data.expertise_list %}selected{% endif %}">
                  <input type="checkbox" name="expertise" value="{{ option }}"
                         {% if option in submitted_data.expertise_list %}checked{% endif %}>
                  <span>{{ option }}</span>
                </label>
              {% endfor %}
            </div>
            <p class="error-message" id="expertiseError" style="display: none; color: #dc2626; font-size: 13px; margin-top: 5px;">Please select at least one expertise</p>
          </div>

          <div class="form-group">
            <label for="profession">Profession *</label>
            <input type="text" id="profession" name="profession" 
                   placeholder="e.g. Research Consultant, Data Analyst" 
                   value="{{ submitted_data.profession|default:'' }}"
                   required>
          </div>

          <div class="form-group">
            <label for="workplace">Workplace *</label>
            <input type="text" id="workplace" name="workplace" 
                   placeholder="e.g. ABC University, XYZ Research Center" 
                   value="{{ submitted_data.workplace|default:'' }}"
                   required>
          </div>

          <div class="form-group">
            <label>Available Days * (Select all that apply)</label>
            <div class="days-grid" id="daysGrid">
              {% for day in days_options %}
                <label class="day-option {% if day|lower in submitted_data.days_list %}selected{% endif %}">
                  <input type="checkbox" name="available_days" value="{{ day|lower }}"
                         {% if day|lower in submitted_data.days_list %}checked{% endif %}>
                  <span>{{ day }}</span>
                </label>
              {% endfor %}
            </div>
            <p class="error-message" id="daysError" style="display: none; color: #dc2626; font-size: 13px; margin-top: 5px;">Please select at least one available day</p>
          </div>

          <div style="display: flex; gap: 20px;">
              <div class="form-group" style="flex: 1;">
                <label for="available_from">Available From *</label>
                <input type="time" id="available_from" name="available_from" 
                       value="{{ submitted_data.available_from|default:'' }}"
                       required>
              </div>

              <div class="form-group" style="flex: 1;">
                <label for="available_to">Available To *</label>
                <input type="time" id="available_to" name="available_to" 
                       value="{{ submitted_data.available_to|default:'' }}"
                       required>
              </div>
          </div>

          <div class="form-group">
            <label for="rate_per_hour">Rate per Hour (â‚±) *</label>
            <input type="number" id="rate_per_hour" name="rate_per_hour" 
                   placeholder="e.g. 500" min="100" max="10000" step="50" 
                   value="{{ submitted_data.rate_per_hour|default:'' }}"
                   required>
            <p class="file-hint">Minimum: â‚±100, Maximum: â‚±10,000</p>
          </div>

          <div class="form-group">
            <label for="meeting_place">Meeting Place *</label>
            <select id="meeting_place" name="meeting_place" required>
              <option value="">Select meeting location</option>
              {% for place in meeting_places_options %}
                <option value="{{ place }}" {% if submitted_data.meeting_place == place %}selected{% endif %}>
                  {{ place }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="description">Service Description (Optional)</label>
            <textarea id="description" name="description" 
                      placeholder="Briefly describe what you offer..." 
                      rows="3" maxlength="500">{{ submitted_data.description|default:'' }}</textarea>
            <p class="file-hint">Maximum 500 characters</p>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-submit">{% if market_listing %}Update{% else %}Submit{% endif %} Listing</button>
          <button type="button" class="btn-cancel" onclick="window.location.href='{% url 'consultant_dashboard' %}'">Cancel</button>
        </div>
      </form>
    </div>
  </main>

  <div id="timeErrorModal" class="modal-overlay">
    <div class="modal-box">
      <span class="modal-icon">âš ï¸</span>
      <h3 class="modal-title">Invalid Time Range</h3>
      <p class="modal-message">The "Available To" time must be later than the "Available From" time. Please adjust your schedule.</p>
      <button class="modal-btn" onclick="closeModal()">Got it</button>
    </div>
  </div>

  <script>
    function setupSelection(selector) {
      const containers = document.querySelectorAll(selector);
      
      containers.forEach(container => {
        const checkbox = container.querySelector('input[type="checkbox"]');
        
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            container.classList.add('selected');
          } else {
            container.classList.remove('selected');
          }
        });
        
        if (checkbox.checked) {
          container.classList.add('selected');
        }
      });
    }

    setupSelection('.expertise-option');
    setupSelection('.day-option');

    const modal = document.getElementById('timeErrorModal');

    function showModal() {
        modal.style.display = 'flex';
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    }

    document.getElementById('marketForm').addEventListener('submit', function(e) {
        const expertiseChecked = document.querySelectorAll('input[name="expertise"]:checked').length;
        const expertiseError = document.getElementById('expertiseError');
        
        const daysChecked = document.querySelectorAll('input[name="available_days"]:checked').length;
        const daysError = document.getElementById('daysError');
        
        let hasError = false;
        
        if (expertiseChecked === 0) {
          e.preventDefault();
          expertiseError.style.display = 'block';
          document.getElementById('expertiseGrid').scrollIntoView({ behavior: 'smooth' });
          hasError = true;
        } else {
          expertiseError.style.display = 'none';
        }

        if (daysChecked === 0) {
          e.preventDefault();
          daysError.style.display = 'block';
          if (!hasError) {
            document.getElementById('daysGrid').scrollIntoView({ behavior: 'smooth' });
          }
          hasError = true;
        } else {
          daysError.style.display = 'none';
        }

        if (hasError) {
          return false;
        }

        const timeFrom = document.getElementById('available_from').value;
        const timeTo = document.getElementById('available_to').value;
        
        // --- UPDATED VALIDATION LOGIC ---
        if (timeFrom && timeTo && timeFrom >= timeTo) {
          e.preventDefault();
          showModal(); // Shows the modal instead of alert()
          return false;
        }
    });
  </script>
</body>
</html>