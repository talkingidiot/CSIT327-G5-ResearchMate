{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ResearchMate ‚Äî Student Profile</title>
  <link rel="stylesheet" href="{% static 'ConsultApp/admin-dashboard.css'%}">
  <link rel="stylesheet" href="{% static 'ConsultApp/student-profile.css'%}">
  <style>
    input[readonly] {
      background-color: #f5f5f5;
      cursor: not-allowed;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <nav class="top-nav">
    <div class="logo">ResearchMate</div>
    
    <div class="nav-links">
      <a href="{% url 'student_dashboard' %}">üè† Dashboard</a>
      <a href="{% url 'student_profile' %}" class="active">üë§ Profile</a>
      <a href="{% url 'student_appointments' %}">üìÖ Appointments</a>
      <a href="{% url 'student_history' %}">üìú History</a>
    </div>

    <div class="user-section">
      <span class="student-label">Student</span>
      <form method="POST" action="{% url 'logout' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="logout-btn">üö™ Logout</button>
      </form>
    </div>
  </nav>

  <main class="main-content">
    <div class="page-header">
      <h1>Student Profile</h1>
      <p>Update your information to be displayed in your dashboard</p>
    </div>

    <div class="profile-progress-container">
      <h3>Profile Completion</h3>

      <div class="progress-bar">
          <div class="progress-fill" style="width: {{ completion_percentage }}%;"></div>
      </div>

      <p class="progress-text">{{ completion_percentage }}% complete</p>

      {% if missing_fields %}
        <ul class="missing-fields">
          {% for f in missing_fields %}
            <li>‚ö† {{ f }} not completed</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>

    <div class="profile-grid">
      <div class="profile-card">
        <div class="profile-avatar">ST</div>
        <h3 id="displayName">{{ student.user.get_full_name|default:"Student" }}</h3>
          <div class="info-item">
            <div class="info-label">Email</div>
            <div class="info-value">{{ student.user.email }}</div>
          </div>

          <div class="info-item">
            <div class="info-label">Department</div>
            <div class="info-value">{{ student.student_department|default:"Not set" }}</div>
          </div>

          <div class="info-item">
            <div class="info-label">Program</div>
            <div class="info-value">{{ student.student_program|default:"Not set" }}</div>
          </div>

          <div class="info-item">
            <div class="info-label">Year Level</div>
            <div class="info-value">
              {% if student.student_year_level > 0 %}
                Year {{ student.student_year_level }}
              {% else %}
                Not set
              {% endif %}
            </div>
          </div>
      </div>

      <div class="form-card">
        <div class="form-header">
            <h2>Profile Information</h2>
            <button type="button" id="editBtn" class="btn-primary" onclick="enableEditing()">
                Edit Profile
            </button>
        </div>
        {% if messages %}
            {% for message in messages %}
                {% if 'success' in message.tags or 'general_error' in message.tags %}
                  <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endif %}
            {% endfor %}
        {% endif %}
        <form method="POST" action="{% url 'student_profile' %}">
          {% csrf_token %}
          
          <div class="form-group">
            <label for="fullName">Full Name <span style="color: #999; font-size: 12px;">(Cannot be changed)</span></label>
            <input type="text" name="fullName" id="fullName" value="{{ student.user.get_full_name }}" readonly>
          </div>

          <div class="form-group">
            <label for="email">Email Address <span style="color: #999; font-size: 12px;">(Cannot be changed)</span></label>
            <input type="email" name="email" id="email" value="{{ student.user.email }}" readonly>
          </div>

          <div class="form-group">
            <label for="department">Department</label>
            <select name="department" id="department">
              <option value="">Select Department</option>
              <option value="CCS" {% if student.student_department == "CCS" %}selected{% endif %}>College of Computer Studies</option>
              <option value="CEA" {% if student.student_department == "CEA" %}selected{% endif %}>College of Engineering and Architecture</option>
              <option value="CMBA" {% if student.student_department == "CMBA" %}selected{% endif %}>College of Management, Business & Accountancy</option>
              <option value="CAS" {% if student.student_department == "CAS" %}selected{% endif %}>College of Arts, Sciences, & Education</option>
              <option value="CNAHS" {% if student.student_department == "CNAHS" %}selected{% endif %}>College of Nursing & Allied Health Sciences</option>
              <option value="CCJ" {% if student.student_department == "CCJ" %}selected{% endif %}>College of Criminal Justice</option>
            </select>
            {% for message in messages %}
                {% if 'department_error' in message.tags %}
                  <p style="color: #dc2626; font-size: 13px; margin-top: 5px;">{{ message }}</p>
                {% endif %}
            {% endfor %}
          </div>

          <div class="form-group">
            <label for="program">Program</label>
            <select name="program" id="program">
              <option value="">Select Program</option>
            </select>
            {% for message in messages %}
                {% if 'program_error' in message.tags %}
                  <p style="color: #dc2626; font-size: 13px; margin-top: 5px;">{{ message }}</p>
                {% endif %}
            {% endfor %}
          </div>

          <div class="form-group">
            <label for="yearLevel">Year Level</label>
            <select name="yearLevel" id="yearLevel">
              <option value="0" {% if student.student_year_level == 0 %}selected{% endif %}>Select Year Level</option>
              <option value="1" {% if student.student_year_level == 1 %}selected{% endif %}>1st Year</option>
              <option value="2" {% if student.student_year_level == 2 %}selected{% endif %}>2nd Year</option>
              <option value="3" {% if student.student_year_level == 3 %}selected{% endif %}>3rd Year</option>
              <option value="4" {% if student.student_year_level == 4 %}selected{% endif %}>4th Year</option>
            </select>
            {% for message in messages %}
                {% if 'year_level_error' in message.tags %}
                  <p style="color: #dc2626; font-size: 13px; margin-top: 5px;">{{ message }}</p>
                {% endif %}
            {% endfor %}
          </div>

          <div class="form-actions" id="actionButtons" style="display: none;">
            <button type="submit" class="btn-primary">üíæ Save Changes</button>
            <button type="button" class="btn-secondary" onclick="cancelEditing()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </main>
  <script>
    const programs = {
      'CEA': [
        'BS Architecture',
        'BS Chemical Engineering',
        'BS Civil Engineering',
        'BS Computer Engineering',
        'BS Electrical Engineering',
        'BS Electronics Engineering',
        'BS Industrial Engineering',
        'BS Mechanical Engineering with Computational Science',
        'BS Mechanical Engineering with Mechatronics',
        'BS Mining Engineering'
      ],
      'CMBA': [
        'BS Accountancy',
        'BS Accounting Information Systems',
        'BS Management Accounting',
        'BS Business Administration - Banking & Financial Management',
        'BS Business Administration - Business Analytics',
        'BS Business Administration - General Business Management',
        'BS Business Administration - Human Resource Management',
        'BS Business Administration - Marketing Management',
        'BS Business Administration - Operations Management',
        'BS Business Administration - Quality Management',
        'BS Hospitality Management',
        'BS Tourism Management',
        'BS Office Administration',
        'Associate in Office Administration',
        'Bachelor in Public Administration'
      ],
      'CAS': [
        'AB Communication',
        'AB English with Applied Linguistics',
        'Bachelor of Elementary Education',
        'Bachelor of Secondary Education - Major in English',
        'Bachelor of Secondary Education - Major in Filipino',
        'Bachelor of Secondary Education - Major in Mathematics',
        'Bachelor of Secondary Education - Major in Science',
        'Bachelor of Multimedia Arts',
        'BS Biology',
        'BS Math with Applied Industrial Mathematics',
        'BS Psychology'
      ],
      'CNAHS': [
        'BS Nursing',
        'BS Pharmacy',
        'BS Medical Technology'
      ],
      'CCS': [
        'BS Computer Science',
        'BS Information Technology'
      ],
      'CCJ': [
        'BS Criminology'
      ]
    };

    const departmentSelect = document.getElementById('department');
    const programSelect = document.getElementById('program');
    const currentProgram = "{{ student.student_program }}";

    function updateProgramOptions() {
      const selectedDept = departmentSelect.value;
      programSelect.innerHTML = '<option value="">Select Program</option>';
      
      if (selectedDept && programs[selectedDept]) {
        programs[selectedDept].forEach(program => {
          const option = document.createElement('option');
          option.value = program;
          option.textContent = program;
          if (program === currentProgram) {
            option.selected = true;
          }
          programSelect.appendChild(option);
        });
      }
    }

    departmentSelect.addEventListener('change', updateProgramOptions);
    
    // Initialize on page load
    updateProgramOptions();

    function enableEditing() {
      document.getElementById('editBtn').style.display = 'none';
      document.getElementById('actionButtons').style.display = 'flex';
      document.getElementById('department').disabled = false;
      document.getElementById('program').disabled = false;
      document.getElementById('yearLevel').disabled = false;
    }

    function cancelEditing() {
      document.getElementById('editBtn').style.display = 'block';
      document.getElementById('actionButtons').style.display = 'none';
      document.getElementById('department').disabled = true;
      document.getElementById('program').disabled = true;
      document.getElementById('yearLevel').disabled = true;
    }
    
    // Disable fields initially
    document.getElementById('department').disabled = true;
    document.getElementById('program').disabled = true;
    document.getElementById('yearLevel').disabled = true;
    
    {% if messages %}
      {% for message in messages %}
          {% if 'error' in message.tags %}
            enableEditing();
          {% endif %}
      {% endfor %}
    {% endif %}
</script>
</body>
</html>